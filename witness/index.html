<html xmlns="http://www.w3.org/2000/xhtml">
  <head>
    <style>
      .line {fill: #6D4D4A} /* Always at index 0 */
      @font-face {src: url('Constantia.ttf')}
      * {
        font-family: Constantia;
        font-variant: small-caps;
        font-weight: bold;
        font-size: 28px;
      }
      table {
        position: relative;
        top: 10%;
        margin: auto;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="style1.css" id="stylesheet">
    <!-- document.getElementById("stylesheet").href = 'style2.css' -->
    <script type="text/javascript" src="engine/polyominos.js"></script>
    <script type="text/javascript" src="engine/utilities.js"></script>
    <script type="text/javascript" src="engine/puzzle.js"></script>
    <script type="text/javascript" src="engine/generate.js"></script>
    <script type="text/javascript" src="engine/solve.js"></script>
    <script type="text/javascript" src="engine/validate.js"></script>
    <script type="text/javascript" src="engine/display.js"></script>
    <script type="text/javascript" src="engine/trace.js"></script>
    <title>Random puzzles or something</title>
  </head>
  <body>

    <div style="text-align: center; font-size: 72">Random puzzles from The Witness</div>
    <div style="text-align: center;">
      <button disabled id="hint" onclick="showHint()">Show Hint</button>
      <button disabled id="soln" onclick="showSolution()">Show Solution</button>
    </div>
    <div style="text-align: center">
      <label for="sens">Mouse Speed 2D</label>
      <input id="sens" type="range" min="0.1" max="1.3" step="0.1" onchange="localStorage.sensitivity = this.value"/>
      <script>document.getElementById('sens').value = localStorage.sensitivity</script>
    </div>

    <table id="puzzle" cellspacing="0" cellpadding="0"></table>
    <script>
      // Initialize our worker (multithreaded processing class) with defaults
      // to allow for cases where multithreading isn't enabled.
      var worker = {
        'postMessage': function(msg) {window.onmessage({'data':msg})}
      }
      if (window.Worker) {
        try {
          worker = new Worker('engine/solve.js');
        } catch (e) {}
      }
      // Callback from the worker, after validating a puzzle it provides
      // a solution. We use this to create showHint() and showSolution()
      worker.onmessage = function(e) {
        var solutions = e.data
        if (solutions == undefined || solutions.length == 0) {
          console.log('%cWarning: This puzzle has no solution. Solve at your own risk!', 'color:red; font-size: large')
          return
        }
        var solution = solutions[_randint(solutions.length)]
        console.trace(solution)
        var hints = []
        for (var x=0; x<solution.grid.length; x++) {
          for (var y=0; y<solution.grid[x].length; y++) {
            if (x%2 + y%2 == 1 && !solution.grid[x][y]) {
              hints.push({'x':x, 'y':y})
            }
          }
        }
        window['showHint'] = function() {
          if (hints.length <= 0) return
          var goodHints = []
          var badHints = []
          for (var hint of hints) {
            // FIXME: This is terrible encapsulation
            var elem = document.getElementById("puzzle_"+hint.x+"_"+hint.y)
            if (!elem.className.endsWith("trace")) {
              // User's solution will be broken by this hint
              goodHints.push(hint)
            } else {
              badHints.push(hint)
            }
          }
          if (goodHints.length > 0) {
            var hint = goodHints.splice(_randint(goodHints.length), 1)[0]
          } else {
            var hint = badHints.splice(_randint(badHints.length), 1)[0]
          }
          puzzle.gaps.push(hint)
          solution.gaps.push(hint)
          draw(puzzle)
          hints = badHints.concat(goodHints)
        }
        window['showSolution'] = function() {
          draw(solution)
        }
        document.getElementById('hint').disabled = false
        document.getElementById('soln').disabled = false
      }

      // Main startup code, detect style + puzzle id, generate, validate, and display puzzle.
      if ('style' in urlParams) {
        if (urlParams['style'] in styles) {
          var style = styles[urlParams['style']]
        } else {
          var style = JSON.parse(urlParams['style'])
        }
      } else {
        var day = [
          'sunday',
          'monday',
          'tuesday',
          'wednesday',
          'thursday',
          'friday',
          'saturday'][(new Date()).getDay()]
        var style = styles[day]
        location.search = 'style='+day
      }
      if (location.hash == "") {
        // If no seed is provided, try to find a valid puzzle with given style
        setSeed(Math.floor(Math.random() * (1 << 30)))
        var puzzleData = validPuzzle(style)
        draw(puzzleData['puzzle'])
        worker.onmessage({'data':puzzleData['solutions']})
        location.hash = puzzleData['seed']
      } else {
        // A seed was provided, so draw the puzzle then validate it async
        setSeed(parseInt(location.hash.substring(1)))
        var puzzle = randomPuzzle(style)
        draw(puzzle)
        worker.postMessage(puzzle.serialize())
      }
    </script>
  </body>
</html>
